<main class="preview-wrapper">
    <div class="preview-page">
        <section class="preview-content">
            <div class="preview-header">
                <!-- Unified Search and Filter Container -->
                <div class="sticky-top">
                    <div class="filter-section" *ngIf="searchResults.length > 0">
                        <div class="table-header">
                            <button class="btn btn-close" (click)="closePreview()"></button>
                        </div>

                        <!-- Mobile toggle buttons -->
                        <div class="mobile-search-toggle">
                            <button class="btn btn-outline-secondary toggle-btn" (click)="toggleFilterForm()" *ngIf="searchResults.length > 0" 
                                    [ngClass]="{'filter-active': hasActiveFilters}">
                                <i class="fas fa-filter"></i>
                                {{ showFilterForm ? 'Hide Filters' : 'Show Filters' }}
                            </button>
                        </div>
                        
                        <div class="filter-container" [ngClass]="{'mobile-hidden': !showFilterForm}">
                            <div class="filter-form">
                                <h5 *ngIf="dataSource.filteredData.length || (searchResults.length && !hasActiveFilters)">
                                    Assets Found ({{ dataSource.filteredData.length || searchResults.length }})
                                    <span *ngIf="hasActiveFilters" class="filter-indicator">
                                        - Filtered from {{ searchResults.length }}
                                    </span>
                                </h5>

                                <h5 *ngIf="dataSource.filteredData.length === 0 && hasActiveFilters" class="text-danger">
                                    Tidak ada aset yang cocok dengan filter saat ini.
                                </h5>
                                
                                <div class="filter-grid">
                                    <div class="filter-title-inline">
                                        <i class="fas fa-filter filter-icon"></i>
                                        <span>Filter:</span>
                                    </div>
                                    
                                    <div class="filter-item">
                                        <input 
                                            id="filter-text"
                                            type="text" 
                                            class="form-control filter-input" 
                                            [(ngModel)]="filterText"
                                            (input)="applyFilters()"
                                            placeholder="Filter by A/T, asset name, S/N, owner, or cost center..."
                                            name="filterText">
                                    </div>
                                    
                                    <div class="filter-item">
                                        <select 
                                            id="filter-condition"
                                            class="form-select filter-select" 
                                            [(ngModel)]="filterCondition"
                                            (change)="applyFilters()"
                                            name="filterCondition">
                                            <option *ngFor="let option of conditionOptions" [value]="option.value">
                                                {{ option.label }}
                                            </option>
                                        </select>
                                    </div>
                                    
                                    <div class="filter-item">
                                        <select 
                                            id="filter-status"
                                            class="form-select filter-select" 
                                            [(ngModel)]="filterStatus"
                                            (change)="applyFilters()"
                                            name="filterStatus">
                                            <option *ngFor="let option of statusOptions" [value]="option.value">
                                                {{ option.label }}
                                            </option>
                                        </select>
                                    </div>

                                    <div class="filter-item">
                                        <select 
                                            id="filter-processing-status"
                                            class="form-select filter-select" 
                                            [(ngModel)]="filterProcessingStatus"
                                            (change)="applyFilters()"
                                            name="filterProcessingStatus">
                                            <option *ngFor="let option of processingStatusOptions" [value]="option.value">
                                                {{ option.label }}
                                            </option>
                                        </select>
                                    </div>
                                    
                                    <button 
                                        type="button" 
                                        class="btn btn-sm btn-outline-secondary reset-btn"
                                        (click)="resetFilters()"
                                        [disabled]="!hasActiveFilters"
                                        title="Clear all filters">
                                        <i class="fas fa-times"></i>
                                        Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="preview-body">
                <div class="table-section">
                    <div class="header-original">
                        <div class="table-header-with-filter">
                            <h6>Original Data</h6>
                            <button 
                                type="button" 
                                class="btn btn-sm filter-toggle-btn"
                                [class.active]="filterTarget === 'original'"
                                (click)="setFilterTarget('original')"
                                [attr.data-bs-toggle]="'tooltip'"
                                [attr.data-bs-placement]="'top'"
                                [attr.title]="'Filter berdasarkan data asli. Data terupdate akan mengikuti hasil filter.'">
                                <i class="fas fa-filter"></i>
                                Apply filter
                                <i class="fas fa-info-circle tooltip-icon" 
                                   [attr.data-bs-toggle]="'tooltip'"
                                   [attr.data-bs-placement]="'top'"
                                   [attr.title]="'Filter berdasarkan data asli. Data terupdate akan mengikuti hasil filter.'"></i>
                            </button>
                        </div>
                        
                        <!-- Original data table -->
                        <div class="table-container" id="original-data-table">
                            <table mat-table [dataSource]="originalDataSource" class="assets-table">
                                <!-- Asset Tag Column -->
                                <ng-container matColumnDef="assetTag">
                                    <th mat-header-cell *matHeaderCellDef>Asset Tag</th>
                                    <td mat-cell *matCellDef="let element" class="asset-tag-cell" 
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'assetTag', element)}">
                                        {{ element.assetTag }}
                                    </td>
                                </ng-container>

                                <!-- Asset Name Column -->
                                <ng-container matColumnDef="assetName">
                                    <th mat-header-cell *matHeaderCellDef>Asset Name</th>
                                    <td mat-cell *matCellDef="let element" class="asset-name-cell" [title]="element.assetName"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'assetName', element)}">
                                        {{ element.assetName }}
                                    </td>
                                </ng-container>

                                <!-- Serial Number Column -->
                                <ng-container matColumnDef="serialNumber">
                                    <th mat-header-cell *matHeaderCellDef>Serial Number</th>
                                    <td mat-cell *matCellDef="let element" 
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'serialNumber', element)}">
                                        {{ element.serialNumber }}
                                    </td>
                                </ng-container>

                                <!-- Equipment Column -->
                                <ng-container matColumnDef="equipments">
                                    <th mat-header-cell *matHeaderCellDef>Equipment</th>
                                    <td mat-cell *matCellDef="let element" class="equipment-cell" [title]="element.equipments"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'equipments', element)}">
                                        {{ element.equipments }}
                                    </td>
                                </ng-container>

                                <!-- Region Column -->
                                <ng-container matColumnDef="regionName">
                                    <th mat-header-cell *matHeaderCellDef>Region</th>
                                    <td mat-cell *matCellDef="let element" class="location-cell" [title]="element.regionName"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'regionName', element)}">
                                        {{ element.regionName }}
                                    </td>
                                </ng-container>

                                <!-- Site Group Column -->
                                <ng-container matColumnDef="siteGroupName">
                                    <th mat-header-cell *matHeaderCellDef>Site Group</th>
                                    <td mat-cell *matCellDef="let element" class="location-cell" [title]="element.siteGroupName"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'siteGroupName', element)}">
                                        {{ element.siteGroupName }}
                                    </td>
                                </ng-container>

                                <!-- Sub Site Column -->
                                <ng-container matColumnDef="subSiteName">
                                    <th mat-header-cell *matHeaderCellDef>Site</th>
                                    <td mat-cell *matCellDef="let element" class="location-cell" [title]="element.subSiteName"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'subSiteName', element)}">
                                        {{ element.subSiteName }}
                                    </td>
                                </ng-container>

                                <!-- Site Column -->
                                <ng-container matColumnDef="siteName">
                                    <th mat-header-cell *matHeaderCellDef>Owner Site</th>
                                    <td mat-cell *matCellDef="let element" class="location-cell" [title]="element.siteName"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'siteName', element)}">
                                        {{ element.siteName }}
                                    </td>
                                </ng-container>

                                <!-- Room Column -->
                                <ng-container matColumnDef="room">
                                    <th mat-header-cell *matHeaderCellDef>Room</th>
                                    <td mat-cell *matCellDef="let element" class="location-cell" [title]="element.room"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'room', element)}">
                                        {{ element.room }}
                                    </td>
                                </ng-container>

                                <!-- User Name Column -->
                                <ng-container matColumnDef="userName">
                                    <th mat-header-cell *matHeaderCellDef>User</th>
                                    <td mat-cell *matCellDef="let element" class="user-name-cell" [title]="element.userName"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'userName', element)}">
                                        {{ element.userName }}
                                    </td>
                                </ng-container>

                                <!-- Position Column -->
                                <ng-container matColumnDef="position">
                                    <th mat-header-cell *matHeaderCellDef>Position</th>
                                    <td mat-cell *matCellDef="let element" class="position-cell" [title]="element.position"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'position', element)}">
                                        {{ element.position }}
                                    </td>
                                </ng-container>

                                <!-- Division Column -->
                                <ng-container matColumnDef="division">
                                    <th mat-header-cell *matHeaderCellDef>Division</th>
                                    <td mat-cell *matCellDef="let element" class="organization-cell" [title]="element.division"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'division', element)}">
                                        {{ element.division }}
                                    </td>
                                </ng-container>

                                <!-- Department Column -->
                                <ng-container matColumnDef="department">
                                    <th mat-header-cell *matHeaderCellDef>Department</th>
                                    <td mat-cell *matCellDef="let element" class="organization-cell" [title]="element.department"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'department', element)}">
                                        {{ element.department }}
                                    </td>
                                </ng-container>

                                <!-- Cost Center Column -->
                                <ng-container matColumnDef="costCenter">
                                    <th mat-header-cell *matHeaderCellDef>Cost Center</th>
                                    <td mat-cell *matCellDef="let element"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'costCenter', element)}">
                                        {{ element.costCenter }}
                                    </td>
                                </ng-container>

                                <!-- Status Column -->
                                <ng-container matColumnDef="status">
                                    <th mat-header-cell *matHeaderCellDef>Status</th>
                                    <td mat-cell *matCellDef="let element"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'status', element)}">
                                        <span class="asset-status" [ngClass]="{
                                            'status-deployed': element.status === 'Deployed',
                                            'status-onloan': element.status === 'On Loan',
                                            'status-inventory': element.status === 'In Inventory',
                                            'status-repair': element.status === 'In Repair',
                                            'status-down': element.status === 'Down',
                                            'status-disposed': element.status === 'Disposed'
                                        }">
                                        {{ element.status }}
                                        </span>
                                    </td>
                                </ng-container>

                                <!-- Condition Column -->
                                <ng-container matColumnDef="condition">
                                    <th mat-header-cell *matHeaderCellDef>Condition</th>
                                    <td mat-cell *matCellDef="let element"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'condition', element)}">
                                        <span class="condition-badge" [ngClass]="{
                                            'condition-good': element.condition === true,
                                            'condition-bad': element.condition === false
                                        }">
                                        {{ element.condition === true ? 'Good' : 'Bad' }}
                                        </span>
                                    </td>
                                </ng-container>

                                <!-- Condition Notes Column -->
                                <ng-container matColumnDef="conditionNotes">
                                    <th mat-header-cell *matHeaderCellDef>Notes</th>
                                    <td mat-cell *matCellDef="let element" class="notes-cell" [title]="element.conditionNotes"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'conditionNotes', element)}">
                                        {{ element.conditionNotes }}
                                    </td>
                                </ng-container>

                                <!-- Asset Opname Status Column -->
                                <ng-container matColumnDef="processingStatus">
                                    <th mat-header-cell *matHeaderCellDef>Process</th>
                                    <td mat-cell *matCellDef="let element"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'processingStatus', element)}">
                                        <span class="processing-status" [ngClass]="{
                                            'status-pending': element.processingStatus === 'pending',
                                            'status-edited': element.processingStatus === 'edited',
                                            'status-all-good': element.processingStatus === 'all_good',
                                        }">
                                        {{ element.processingStatus === 'pending' ? 'Pending' : element.processingStatus === 'edited' ? 'Diperbarui' : 'Sesuai' }}
                                        </span>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="changeReason">
                                    <th mat-header-cell *matHeaderCellDef>Reason for Changes</th>
                                    <td mat-cell *matCellDef="let element" class="change-reason-cell" [title]="element.changeReason"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'changeReason', element)}">
                                        {{ element.changeReason }}
                                    </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                            </table>
                        </div>
                    </div>

                    <div class="header-updated">
                        <div class="table-header-with-filter">
                            <h6>Updated Data</h6>
                            <button 
                                type="button" 
                                class="btn btn-sm filter-toggle-btn"
                                [class.active]="filterTarget === 'updated'"
                                (click)="setFilterTarget('updated')"
                                [attr.data-bs-toggle]="'tooltip'"
                                [attr.data-bs-placement]="'top'"
                                [attr.title]="'Filter berdasarkan data terupdate. Data asli akan mengikuti hasil filter.'">
                                <i class="fas fa-filter"></i>
                                Apply filter
                                <i class="fas fa-info-circle tooltip-icon" 
                                   [attr.data-bs-toggle]="'tooltip'"
                                   [attr.data-bs-placement]="'top'"
                                   [attr.title]="'Filter berdasarkan data terupdate. Data asli akan mengikuti hasil filter.'"></i>
                            </button>
                        </div>

                        <div class="table-container" id="updated-data-table">
                            <table mat-table [dataSource]="updatedDataSource" class="assets-table">
                                <!-- Asset Tag Column -->
                                <ng-container matColumnDef="assetTag">
                                    <th mat-header-cell *matHeaderCellDef>Asset Tag</th>
                                    <td mat-cell *matCellDef="let element" class="asset-tag-cell" 
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'assetTag', element)}">
                                        {{ element.assetTag }}
                                    </td>
                                </ng-container>

                                <!-- Asset Name Column -->
                                <ng-container matColumnDef="assetName">
                                    <th mat-header-cell *matHeaderCellDef>Asset Name</th>
                                    <td mat-cell *matCellDef="let element" class="asset-name-cell" [title]="element.assetName"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'assetName', element)}">
                                        {{ element.assetName }}
                                    </td>
                                </ng-container>

                                <!-- Serial Number Column -->
                                <ng-container matColumnDef="serialNumber">
                                    <th mat-header-cell *matHeaderCellDef>Serial Number</th>
                                    <td mat-cell *matCellDef="let element" 
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'serialNumber', element)}">
                                        {{ element.serialNumber }}
                                    </td>
                                </ng-container>

                                <!-- Equipment Column -->
                                <ng-container matColumnDef="equipments">
                                    <th mat-header-cell *matHeaderCellDef>Equipment</th>
                                    <td mat-cell *matCellDef="let element" class="equipment-cell" [title]="element.equipments"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'equipments', element)}">
                                        {{ element.equipments }}
                                    </td>
                                </ng-container>

                                <!-- Region Column -->
                                <ng-container matColumnDef="regionName">
                                    <th mat-header-cell *matHeaderCellDef>Region</th>
                                    <td mat-cell *matCellDef="let element" class="location-cell" [title]="element.regionName"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'regionName', element)}">
                                        {{ element.regionName }}
                                    </td>
                                </ng-container>

                                <!-- Site Group Column -->
                                <ng-container matColumnDef="siteGroupName">
                                    <th mat-header-cell *matHeaderCellDef>Site Group</th>
                                    <td mat-cell *matCellDef="let element" class="location-cell" [title]="element.siteGroupName"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'siteGroupName', element)}">
                                        {{ element.siteGroupName }}
                                    </td>
                                </ng-container>

                                <!-- Sub Site Column -->
                                <ng-container matColumnDef="subSiteName">
                                    <th mat-header-cell *matHeaderCellDef>Site</th>
                                    <td mat-cell *matCellDef="let element" class="location-cell" [title]="element.subSiteName"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'subSiteName', element)}">
                                        {{ element.subSiteName }}
                                    </td>
                                </ng-container>

                                <!-- Site Column -->
                                <ng-container matColumnDef="siteName">
                                    <th mat-header-cell *matHeaderCellDef>Owner Site</th>
                                    <td mat-cell *matCellDef="let element" class="location-cell" [title]="element.siteName"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'siteName', element)}">
                                        {{ element.siteName }}
                                    </td>
                                </ng-container>

                                <!-- Room Column -->
                                <ng-container matColumnDef="room">
                                    <th mat-header-cell *matHeaderCellDef>Room</th>
                                    <td mat-cell *matCellDef="let element" class="location-cell" [title]="element.room"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'room', element)}">
                                        {{ element.room }}
                                    </td>
                                </ng-container>

                                <!-- User Name Column -->
                                <ng-container matColumnDef="userName">
                                    <th mat-header-cell *matHeaderCellDef>User</th>
                                    <td mat-cell *matCellDef="let element" class="user-name-cell" [title]="element.userName"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'userName', element)}">
                                        {{ element.userName }}
                                    </td>
                                </ng-container>

                                <!-- Position Column -->
                                <ng-container matColumnDef="position">
                                    <th mat-header-cell *matHeaderCellDef>Position</th>
                                    <td mat-cell *matCellDef="let element" class="position-cell" [title]="element.position"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'position', element)}">
                                        {{ element.position }}
                                    </td>
                                </ng-container>

                                <!-- Division Column -->
                                <ng-container matColumnDef="division">
                                    <th mat-header-cell *matHeaderCellDef>Division</th>
                                    <td mat-cell *matCellDef="let element" class="organization-cell" [title]="element.division"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'division', element)}">
                                        {{ element.division }}
                                    </td>
                                </ng-container>

                                <!-- Department Column -->
                                <ng-container matColumnDef="department">
                                    <th mat-header-cell *matHeaderCellDef>Department</th>
                                    <td mat-cell *matCellDef="let element" class="organization-cell" [title]="element.department"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'department', element)}">
                                        {{ element.department }}
                                    </td>
                                </ng-container>

                                <!-- Cost Center Column -->
                                <ng-container matColumnDef="costCenter">
                                    <th mat-header-cell *matHeaderCellDef>Cost Center</th>
                                    <td mat-cell *matCellDef="let element"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'costCenter', element)}">
                                        {{ element.costCenter }}
                                    </td>
                                </ng-container>

                                <!-- Status Column -->
                                <ng-container matColumnDef="status">
                                    <th mat-header-cell *matHeaderCellDef>Status</th>
                                    <td mat-cell *matCellDef="let element"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'status', element)}">
                                        <span class="asset-status" [ngClass]="{
                                            'status-deployed': element.status === 'Deployed',
                                            'status-onloan': element.status === 'On Loan',
                                            'status-inventory': element.status === 'In Inventory',
                                            'status-repair': element.status === 'In Repair',
                                            'status-down': element.status === 'Down',
                                            'status-disposed': element.status === 'Disposed'
                                        }">
                                        {{ element.status }}
                                        </span>
                                    </td>
                                </ng-container>

                                <!-- Condition Column -->
                                <ng-container matColumnDef="condition">
                                    <th mat-header-cell *matHeaderCellDef>Condition</th>
                                    <td mat-cell *matCellDef="let element"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'condition', element)}">
                                        <span class="condition-badge" [ngClass]="{
                                            'condition-good': element.condition === true,
                                            'condition-bad': element.condition === false
                                        }">
                                        {{ element.condition === true ? 'Good' : 'Bad' }}
                                        </span>
                                    </td>
                                </ng-container>

                                <!-- Condition Notes Column -->
                                <ng-container matColumnDef="conditionNotes">
                                    <th mat-header-cell *matHeaderCellDef>Notes</th>
                                    <td mat-cell *matCellDef="let element" class="notes-cell" [title]="element.conditionNotes"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'conditionNotes', element)}">
                                        {{ element.conditionNotes }}
                                    </td>
                                </ng-container>

                                <!-- Asset Opname Status Column -->
                                <ng-container matColumnDef="processingStatus">
                                    <th mat-header-cell *matHeaderCellDef>Process</th>
                                    <td mat-cell *matCellDef="let element"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'processingStatus', element)}">
                                        <span class="processing-status" [ngClass]="{
                                            'status-pending': element.processingStatus === 'pending',
                                            'status-edited': element.processingStatus === 'edited',
                                            'status-all-good': element.processingStatus === 'all_good',
                                        }">
                                        {{ element.processingStatus === 'pending' ? 'Pending' : element.processingStatus === 'edited' ? 'Diperbarui' : 'Sesuai' }}
                                        </span>
                                    </td>
                                </ng-container>

                                <ng-container matColumnDef="changeReason">
                                    <th mat-header-cell *matHeaderCellDef>Reason for Changes</th>
                                    <td mat-cell *matCellDef="let element" class="change-reason-cell" [title]="element.changeReason"
                                        [ngClass]="{'cell-changed': isFieldChanged(element.assetTag, 'changeReason', element)}">
                                        {{ element.changeReason }}
                                    </td>
                                </ng-container>

                                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</main>