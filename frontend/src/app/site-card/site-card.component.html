<div class="sticky-top">
    <!-- Mobile search toggle button -->
    <div class="mobile-search-toggle" (click)="toggleSearchForm()">
        <button class="btn btn-outline-primary toggle-btn">
            <i class="fas fa-search"></i>
            {{ showSearchForm ? 'Hide Search' : 'Show Search' }}
        </button>
    </div>

    <!-- Search form container -->
    <div class="search-form-container" [ngClass]="{'mobile-hidden': !showSearchForm}">
        <h6 class="search-title">Opname Location Search</h6>
        
        <form class="compact-search-form" (ngSubmit)="onSearchSubmit()">
            <!-- HO/Area Toggle -->
            <div class="form-item toggle-section">
                <label>Search In:</label>
                <div class="toggle-buttons">
                    <button type="button" 
                            class="btn toggle-btn" 
                            [class.active]="searchCriteria.searchIn === 'area'"
                            (click)="toggleSearchMode('area')">
                        Area
                    </button>
                    <button type="button" 
                            class="btn toggle-btn" 
                            [class.active]="searchCriteria.searchIn === 'ho'"
                            (click)="toggleSearchMode('ho')">
                        Head Office
                    </button>
                </div>
            </div>
            
            <div class="form-grid">
                <!-- Site Name (for Area mode) -->
                <div class="form-item" *ngIf="searchCriteria.searchIn === 'area'">
                    <label>Site Name</label>
                    <input 
                        type="text" 
                        class="form-control" 
                        [(ngModel)]="searchCriteria.siteName"
                        name="siteName"
                        placeholder="Site name">
                </div>

                <!-- Site Group (for Area mode) -->
                <div class="form-item" *ngIf="searchCriteria.searchIn === 'area'">
                    <label>Site Group</label>
                    <input 
                        type="text" 
                        class="form-control" 
                        [(ngModel)]="searchCriteria.siteGroupName"
                        name="siteGroupName"
                        placeholder="Site group">
                </div>

                <!-- Department Name (for HO mode) -->
                <div class="form-item" *ngIf="searchCriteria.searchIn === 'ho'">
                    <label>Department Name</label>
                    <input 
                        type="text" 
                        class="form-control"
                        [(ngModel)]="searchCriteria.deptName"
                        name="deptName"
                        placeholder="Department name">
                </div>

                <!-- Sub Site Name (for Area mode) -->
                <div class="form-item" *ngIf="searchCriteria.searchIn === 'area'">
                    <label>Sub Site</label>
                    <input 
                        type="text" 
                        class="form-control"
                        [(ngModel)]="searchCriteria.subSiteName"
                        name="subSiteName"
                        placeholder="Sub site name">
                </div>

                <div class="form-item">
                    <label>Created By</label>
                    <input 
                        type="text" 
                        class="form-control" 
                        [(ngModel)]="searchCriteria.createdBy"
                        name="createdBy"
                        placeholder="Search by user name"
                        list="users">
                    <datalist id="users">
                        <option *ngFor="let user of allUsers" [value]="user.firstName + ' ' + user.lastName">
                            {{ user.firstName }} {{ user.lastName }} ({{ user.username }})
                        </option>
                    </datalist>
                </div>
                
                <div class="form-item">
                    <label>Status</label>
                    <select 
                        class="form-select" 
                        [(ngModel)]="searchCriteria.opnameStatus"
                        name="opnameStatus">
                        <option value="">All Status</option>
                        <option value="Active">Active</option>
                        <option value="Submitted">Submitted</option>
                        <option value="Escalated">Escalated</option>
                        <option value="Verified">Verified</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Outdated">Outdated</option>
                    </select>
                </div>
                
                <div class="form-item">
                    <label>From Date</label>
                    <input 
                        type="date" 
                        class="form-control" 
                        [(ngModel)]="searchCriteria.fromDate"
                        name="fromDate">
                </div>
                
                <div class="form-item">
                    <label>To Date</label>
                    <input 
                        type="date" 
                        class="form-control" 
                        [(ngModel)]="searchCriteria.endDate"
                        name="endDate">
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary search-btn">Search</button>
                <button type="button" class="btn btn-secondary reset-btn" (click)="resetSearchForm()">Reset</button>
            </div>
        </form>
    </div>
</div>

<!-- Loading state -->
<section *ngIf="isLoading" class="loading-container">
    <div class="loading-message">
        <h4>Searching sites...</h4>
        <p>Mohon tunggu, sedang mengambil hasil pencarian Anda.</p>
    </div>
</section>

<!-- Search results -->
<section class="site-list-layout" *ngIf="!isLoading && hasSearched && opnameLocations && opnameLocations.length > 0">
    <div class="results-header">
        <h6 class="header-title">Search Results ({{ totalItems }} location{{ totalItems !== 1 ? 's' : '' }} found)</h6>
        <!-- Pagination -->
        <div class="pagination-container">
            <mat-paginator
                [length]="totalItems"
                [pageSize]="pageSize"
                [pageIndex]="pageIndex"
                [pageSizeOptions]="[5, 10, 25, 50]"
                (page)="onPageChange($event)"
                showFirstLastButtons="true">
            </mat-paginator>
        </div>
    </div>
    
    <div class="site-list" *ngFor="let location of opnameLocations" 
         (click)="onLocationClick(location)"
         style="cursor: pointer;">
        <div class="first-column">
            <h6 class="site-name">
                {{ searchCriteria.searchIn === 'ho' ? (location.deptName || 'Unknown Department') : (location.siteName || 'Unknown Site') }}
            </h6>
            <p class="site-details">
                {{ searchCriteria.searchIn === 'ho' ? 'Head Office' : ((location.siteGroupName || 'Unknown Group') + ' â€¢ ' + (location.regionName || 'Unknown Region')) }}
            </p>
            <p class="opname-date">
                Last Opname: {{ (location.lastOpnameDate | date:'short') || 'No opname yet'}}
            </p>
            <p class="opname-user">
                Created by: {{ location.lastOpnameBy || 'Unknown user' }}
            </p>
        </div>

        <div class="second-column">
            <span class="site-status" 
                  *ngIf="location.opnameStatus"
                  [ngClass]="{
                      'status-active': location.opnameStatus === 'Active',
                      'status-submitted': location.opnameStatus === 'Submitted',
                      'status-escalated': location.opnameStatus === 'Escalated',
                      'status-verified': location.opnameStatus === 'Verified',
                      'status-rejected': location.opnameStatus === 'Rejected',
                      'status-outdated': location.opnameStatus === 'Outdated'
                  }">
                {{ location.opnameStatus }}
            </span>
            <span class="site-status status-new" *ngIf="!location.opnameStatus">
                No Opname Yet
            </span>
        </div>
    </div>

    <!-- Bottom Pagination -->
    <div class="pagination-container">
        <mat-paginator
            [length]="totalItems"
            [pageSize]="pageSize"
            [pageIndex]="pageIndex"
            (page)="onPageChange($event)"
            [showFirstLastButtons]="true"
            [hidePageSize]="true">
        </mat-paginator>
    </div>
</section>

<!-- No results found -->
<section class="empty-search" *ngIf="!isLoading && hasSearched && opnameLocations && opnameLocations.length === 0">
    <div class="not-found-message">
        <h4>No locations found</h4>
        <p>Tidak ada lokasi yang cocok dengan kriteria pencarian Anda. Silakan ubah filter dan coba lagi.</p>
    </div>
</section>

<!-- Initial state - no search performed -->
<section class="initial-state" *ngIf="!isLoading && !hasSearched">
    <div class="welcome-message">
        <h4>Ready to search opname locations</h4>
        <p>Gunakan formulir pencarian di atas untuk mencari lokasi opname.</p>
    </div>
</section>

<!-- ERROR MESSAGE -->
<div *ngIf="errorMessage && showToast" class="my-toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
        <div class="toast-body">
            <p>{{ errorMessage }}</p>
        </div>
        <button type="button" class="btn-close btn-close-black m-auto" (click)="showToast = false" aria-label="Close"></button>
    </div>
</div>