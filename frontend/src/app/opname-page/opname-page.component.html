<main class="opname-wrapper">
    <div class="opname-page">
        <!-- ERROR MESSAGE -->
        <div *ngIf="errorMessage && showToast" class="my-toast align-items-center" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <p>{{ errorMessage }}</p>
                </div>
                <button type="button" class="btn-close btn-close-black m-auto" (click)="showToast = false" aria-label="Close"></button>
            </div>
        </div>

        <section class="opname-content">
            <div class="opname-header">
                <div class="opname-details">
                    <h5>Opname sedang berlangsung...</h5>
                    <p>{{ site.siteName }}</p>
                    <p>Started on {{ opnameSession.startDate }}</p>
                </div>
                <div class="buttons">
                    <div class="finish-button">
                        <button class="btn btn-success" (click)="openModal('opnameFinished')">
                            Selesai
                        </button>
                    </div>

                    <div class="cancel-button">
                        <button type="button" class="btn btn-danger" (click)="openModal('opnameCanceled')">
                            Batalkan
                        </button>
                    </div>
                </div>
            </div>

            <mat-progress-bar class="divider" mode="determinate" value="50"></mat-progress-bar>

            <div class="opname-body">
                <app-opname-asset [sessionID]="sessionID" [siteID]="siteID"></app-opname-asset>
            </div>
        </section>
    </div>
</main>

<div class="modal fade" id="opnameFinished" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" [ngClass]="{'modal-no-asset-count': invalidSession === 'asset-count', 'modal-pending-count': invalidSession === 'pending-count'}">
            <div class="modal-header">
                <h5 class="modal-title fs-5" id="staticBackdropLabel" *ngIf="!invalidSession">Apakah Anda yakin ingin menyelesaikan opname?</h5>
                <h5 class="modal-title fs-5" id="staticBackdropLabel" *ngIf="invalidSession === 'asset-count'">
                    <i class="fas fa-exclamation-triangle text-danger"></i> Tidak ada aset yang dipindai.
                </h5>
                <h5 class="modal-title fs-5" id="staticBackdropLabel" *ngIf="invalidSession === 'pending-count'">
                    <i class="fas fa-exclamation-triangle text-warning"></i> Masih ada aset yang belum diproses.
                </h5>
            </div>
            <div class="modal-body">
                <p class="confirmation-text" *ngIf="!invalidSession">
                    Tindakan ini akan menyelesaikan sesi opname saat ini dan <strong>semua perubahan data akan disimpan</strong>.
                    <br>
                    <br>
                    <strong>Catatan:</strong> Tindakan ini tidak dapat dibatalkan. Setelah selesai, <strong class="text-danger">Anda tidak akan dapat melakukan perubahan lebih lanjut</strong> pada aset dalam sesi ini. Pastikan semua data sudah benar sebelum melanjutkan.
                </p>
                <p class="confirmation-text" *ngIf="invalidSession === 'asset-count'">
                    Sesi opname tidak dapat diselesaikan karena <span class="text-danger">belum ada aset</span> yang dipindai. Silakan lakukan pemindaian aset terlebih dahulu sebelum melanjutkan.<br><br>
                    <strong>Catatan:</strong> Pastikan minimal satu aset sudah dipindai agar sesi dapat diselesaikan.
                </p>
                <p class="confirmation-text" *ngIf="invalidSession === 'pending-count'">
                    Sesi opname tidak dapat diselesaikan karena masih ada <span class="pending-text-color">aset yang belum diproses</span>. Silakan verifikasi atau perbarui data aset tersebut sebelum melanjutkan.<br><br>
                    <strong>Tips:</strong> Gunakan filter proses <strong>pending</strong> pada daftar aset untuk menampilkan hanya aset yang masih perlu diproses.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeModal('opnameFinished')">Tutup</button>
                <button class="btn btn-success" (click)="finishOpnameSession()" *ngIf="!invalidSession">
                    <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span *ngIf="!isLoading">Selesai</span>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="opnameCanceled" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Apakah Anda yakin ingin membatalkan opname?</h1>
            </div>
            <div class="modal-body">
                <p class="confirmation-text">
                    Tindakan ini akan membatalkan sesi opname saat ini dan <strong class="text-danger">semua perubahan data akan hilang</strong>.
                    <br>
                    <br>
                    <strong>Catatan:</strong> Tindakan ini tidak dapat dibatalkan.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeModal('opnameCanceled')">Tutup</button>
                <button class="btn btn-danger" (click)="cancelOpnameSession()">
                    <span *ngIf="isLoading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span *ngIf="!isLoading">Batalkan</span>
                </button>
            </div>
        </div>
    </div>
</div>
